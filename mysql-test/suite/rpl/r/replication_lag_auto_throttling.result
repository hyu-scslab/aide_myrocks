include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
[connection master]
SET @@GLOBAL.bypass_write_throttle_admin_check=1;
SET @@GLOBAL.WRITE_STATS_FREQUENCY=1;
SET @@GLOBAL.SQL_STATS_CONTROL="ON";
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=1;
SET @@GLOBAL.WRITE_STATS_FREQUENCY=1;
SET @@GLOBAL.WRITE_THROTTLE_LAG_PCT_MIN_SECONDARIES=10;
SET @@GLOBAL.WRITE_START_THROTTLE_LAG_MILLISECONDS=3000;
SET @@GLOBAL.WRITE_STOP_THROTTLE_LAG_MILLISECONDS=1000;
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=1.5;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="SQL_ID,SHARD,CLIENT,USER";
Set sql_mode to traditional by which warnings are raised as errors
except when the warning comes from the throttling features (write)
set @@GLOBAL.sql_mode=traditional;
create table t(a int) engine=innodb;
create database test1;
create table test1.t(a int) engine=innodb;
select @@GLOBAL.WRITE_STATS_FREQUENCY into @ws_freq;
select @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY into @wat_freq;
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.skip_last_complete_bucket_check';
####################################################
### Test 1: Auto throttle start & stop based on sql_id
####################################################
insert into t values(1);
### Setting the following debug variable makes sure that any subsequent queries are added to the same write statistics add_write_stats_to_most_recent_bucket
### as that for the query above it. This helps us mimic a time bucket for write statistics deterministically for testing. 
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
insert into t values(2);
delete from t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	108
SHARD	test	108
SQL_ID	1586ffa412d4a296baf93bdd932f03d7	36
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a	72
USER	root	108
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
####### Next Cycle #######
### Expectation - There is replication lag. The system should identity insert query sql_id as the culprit and start monitoring it ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
insert into t values(2);
delete from t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
####### Next Cycle #######
### Expectation - Replication lag still persists, Insert query sql_id should be throttled. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into t values(2);
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	1
select count from information_schema.write_throttling_log where type = 'SQL_ID' and mode = 'AUTO';
count
1
####### Next Cycle #######
### Expectation - Replication lag between start and end threshold, Expect warning for every insert query. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_between_start_end_throttle_threshold';
insert into t values(2);
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	2
select count from information_schema.write_throttling_log where type = 'SQL_ID' and mode = 'AUTO';
count
2
####### Next Cycle #######
### Expectation - Replication lag goes away, Insert query should not be throttled anymore. Expect warnings count to not increase anymore. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_between_start_end_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into t values(2);
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	2
select count from information_schema.write_throttling_log where type = 'SQL_ID' and mode = 'AUTO';
count
2
####### Reset #######
TRUNCATE t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 2: Auto throttle start & stop based on shard
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	144
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. The system should identity shard 'test' as the culprit since there is no conclusive sql_id culprit. Should start monitoring 'test' shard ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
####### Next Cycle #######
### Expectation - Replication lag still persists, Shard 'test' should be throttled. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SHARD	test
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	1
select count from information_schema.write_throttling_log where type = 'SHARD' and mode = 'AUTO';
count
1
####### Next Cycle #######
### Expectation - Replication lag goes away, Shard 'test' should not be throttled anymore. Expect warnings count to not increase anymore. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into test1.t values(2);
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	1
select count from information_schema.write_throttling_log where type = 'SHARD' and mode = 'AUTO';
count
1
####### Reset #######
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 3: Auto throttle fallback sql id in case of no 
### conclusive culprit
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=3;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
insert into test.t values(2);
delete from test.t where a = 2;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	185
SHARD	test	185
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	41
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	72
USER	root	185
set @@global.debug= '+d,dbug.simulate_fallback_sql_throttling';
####### Next Cycle #######
### Expectation - There is replication lag. As per the setup, the system should fallback to monitoring the top sql_id(insert query) with most bytes written. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
insert into test.t values(2);
delete from test.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	113
SHARD	test	113
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	41
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	72
USER	root	113
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
####### Next Cycle #######
### Expectation - Replication lag still persists, Insert query sql_id should be throttled. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test.t values(2);
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	1
####### Next Cycle #######
### Expectation - Replication lag goes away, Insert query sql_id should not be throttled anymore. Expect warnings count to not increase anymore. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into test.t values(2);
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	1
####### Reset #######
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=1.5;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
set @@global.debug= '-d,dbug.simulate_fallback_sql_throttling';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 4: Auto throttle multiple sql_ids and releasing
### them in order one by one after replication lag goes away
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
insert into t values(1);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
insert into t values(2);
insert into t values(3);
insert into t values(4);
delete from t where a = 1;
delete from t where a = 2;
update t set a = 1 where a = 3;
update t set a = 2 where a = 4;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	300
SHARD	test	300
SQL_ID	1586ffa412d4a296baf93bdd932f03d7	72
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a	144
SQL_ID	2fec1ab9f8d260a5cbdba621b111dc62	84
USER	root	300
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
####### Next Cycle #######
### Expectation - There is replication lag. The system should identify insert query sql_id as the culprit and start throttling it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into t values(3);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
update t set a = 4 where a = 3;
delete from t where a = 1;
delete from t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	1
####### Next Cycle #######
### Expectation - Replication lag still persists. The system should identify delete query sql_id as the culprit and start throttling it as well. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into t values(3);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from t where a = 4;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	1586ffa412d4a296baf93bdd932f03d7
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	3
####### Next Cycle #######
### Expectation - Replication lag goes away. The system should stop throttling insert query but still throttle delete query. Expect warnings from delete queries ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into t values(4);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from t where a = 3;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	1586ffa412d4a296baf93bdd932f03d7
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	4
####### Next Cycle #######
### Expectation - Replication lag goes away. The system should release the delete query now and stop throttling it. Expect warnings count to not increase ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into t values(5);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from t where a = 4;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	4
####### Reset #######
TRUNCATE t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 5: Monitored entities are dynamically updated if 
### a new potential culprit is found
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
insert into t values(1);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
insert into t values(2);
insert into t values(3);
insert into t values(4);
insert into t values(5);
insert into t values(6);
insert into t values(7);
delete from t where a = 6;
delete from t where a = 7;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	324
SHARD	test	324
SQL_ID	1586ffa412d4a296baf93bdd932f03d7	72
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a	252
USER	root	324
####### Next Cycle #######
### Expectation - There is replication lag. The system should identify insert query sql_id as the culprit and start monitoring it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into t values(6);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from t where a = 1;
delete from t where a = 2;
delete from t where a = 3;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	144
SQL_ID	1586ffa412d4a296baf93bdd932f03d7	108
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a	36
USER	root	144
####### Next Cycle #######
### Expectation - Replication lag still persists but in the last cycle the system should identify delete query as the culprit and update the sql_id to be monitored. Should not throttle it yet. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into t values(6);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from t where a = 4;
delete from t where a = 5;
delete from t where a = 6;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	149
SHARD	test	149
SQL_ID	1586ffa412d4a296baf93bdd932f03d7	113
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a	36
USER	root	149
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
####### Next Cycle #######
### Expectation - Replication lag still persists. The system should identify delete query as the culprit and throttle it. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into t values(1);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from t where a = 1;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	1586ffa412d4a296baf93bdd932f03d7
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	72
SHARD	test	72
SQL_ID	1586ffa412d4a296baf93bdd932f03d7	36
SQL_ID	2cea509ba0e3065c09c1efe4c77e392a	36
USER	root	72
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	1
####### Reset #######
TRUNCATE t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 6: Auto throttle start & stop based on client
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	72
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. Based on the write stats, there is no clear sql_id or shard as the culprit. Should identify client_id as the culprit and throttle it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test1.t where a = 2;
insert into test.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
CLIENT	99914b932bd37a50b983c5e7c90ae93b
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	4
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 6: Only permissible query types are throttled
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=ERROR;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_QUERY_TYPES="UPDATE";
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	72
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. Based on the write stats, there is no clear sql_id or shard as the culprit. Should identify client_id as the culprit and throttle it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
# should quarantine the client, all next queries(UPDATE ONLY) should error
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test1.t where a = 2;
insert into test1.t values(2);
update test1.t set a = 3 where a = 2;
ERROR HY000: Exceeded write workload limit. Try again later
# should throttle both updates & deletes if WRITE_THROTTLE_PERMISSIBLE_QUERY_TYPES=UPDATE,DELETE
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_QUERY_TYPES="UPDATE,DELETE";
insert into test1.t values(4);
update test1.t set a = 4 where a = 5;
ERROR HY000: Exceeded write workload limit. Try again later
delete from test1.t where a = 4;
ERROR HY000: Exceeded write workload limit. Try again later
# should throttle all writes if WRITE_THROTTLE_PERMISSIBLE_QUERY_TYPES=OFF
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_QUERY_TYPES="OFF";
insert into test1.t values(4);
ERROR HY000: Exceeded write workload limit. Try again later
update test1.t set a = 4 where a = 5;
ERROR HY000: Exceeded write workload limit. Try again later
delete from test1.t where a = 4;
ERROR HY000: Exceeded write workload limit. Try again later
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
CLIENT	99914b932bd37a50b983c5e7c90ae93b
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 7: No throttling if WRITE_AUTO_THROTTLE_FREQUENCY = 0
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=0;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	72
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag but WRITE_AUTO_THROTTLE_FREQUENCY is set to 0. The system should not throttle any entity. No warnings ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test1.t where a = 2;
insert into test.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=@wat_freq;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 8: Auto throttle throws error if write_control_level=ERROR
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=ERROR;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	72
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. The client should be identified as the entity to be throttled ###
### Should throw erros when WRITE_CONTROL_LEVEL is set to ERROR but should only throw warnings when it is set to WARN ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
ERROR HY000: Exceeded write workload limit. Try again later
delete from test1.t where a = 2;
ERROR HY000: Exceeded write workload limit. Try again later
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
CLIENT	99914b932bd37a50b983c5e7c90ae93b
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	4
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
################################################################################
### Test 9: Auto throttle throws error if client attribute mt_throttle_okay is set.
################################################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
SET @@GLOBAL.WRITE_THROTTLE_PARSE_QUERY_COMMENTS=1;
SET @@SESSION.WRITE_THROTTLE_TAG_ONLY=TRUE;
### Store total error logs until now for comparison later ###
Select sum(count) from information_schema.write_throttling_log into @log_count;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	72
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. The client should be identified as the entity to be throttled ###
### Should throw errors when client attribute mt_throttle_okay is set to ERROR but should only throw warnings when it is set to WARN ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
### should quarantine the client, next query should not be throttled as the query tag is not present
insert into test1.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
### next query should be throttled(warning) as the query tag is present
insert into test1.t values(2);
### next query should be throttled(warning) as the query tag is present in query comments
/* mtthrottle-W */ insert into test1.t values(2);
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	2
### next query should be throttled(error) as the query tag is present
insert into test1.t values(2);
ERROR HY000: Exceeded write workload limit. Try again later
### next query should be throttled(error) as the query tag is present in query comments
/* mtthrottle-E */ insert into test1.t values(2);
ERROR HY000: Exceeded write workload limit. Try again later
### next query should not be throttled(error) as the query tag is not set correctly
/* mtthrottle-X */ insert into test1.t values(2);
SET @@GLOBAL.WRITE_THROTTLE_PARSE_QUERY_COMMENTS=DEFAULT;
### next query should not be throttled(error) as the query tag is present in query comments but WRITE_THROTTLE_PARSE_QUERY_COMMENTS=0
/* mtthrottle-E */ insert into test1.t values(2);
### next query should not be throttled as tag is not set correctly
insert into test1.t values(2);
### multi-query should also be throttled based on tag present at the beginning. 
select 1; 
insert into test1.t values(2);
||||
1
1
ERROR HY000: Exceeded write workload limit. Try again later
SET @@SESSION.WRITE_THROTTLE_TAG_ONLY=FALSE;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=ERROR;
### next query should be throttled as tag based throttling is turned off but client is still the culprit
insert into test1.t values(2);
ERROR HY000: Exceeded write workload limit. Try again later
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
CLIENT	99914b932bd37a50b983c5e7c90ae93b
select error_code, error_name, errors_total from information_schema.ERROR_STATISTICS where error_code = 50092;
error_code	error_name	errors_total
50092	ER_WRITE_QUERY_THROTTLED	6
### Total throttling error/warning for this test  ###
Select CAST(sum(count) - @log_count AS UNSIGNED) from information_schema.write_throttling_log;
CAST(sum(count) - @log_count AS UNSIGNED)
6
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@SESSION.WRITE_THROTTLE_TAG_ONLY=FALSE;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 10: Gradual auto throttling
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_THROTTLE_RATE_STEP=25;
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	72
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. Based on the write stats, there is no clear sql_id or shard as the culprit. Should identify client_id as the culprit and throttle it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	25
####### Next Cycle #######
### Expectation - Replication lag still persists. Should increase throttle_rate to 50% ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	50
####### Next Cycle #######
### Expectation - Replication lag still persists. Should increase throttle_rate to 75% ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	75
####### Next Cycle #######
### Expectation - Replication lag still persists. Should increase throttle_rate to 100% ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	100
####### Next Cycle #######
### Expectation - Replication lag still persists but it is between start and end threshold. Should keep throttle_rate to 100% ###
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_between_start_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	100
####### Next Cycle #######
### Expectation - Replication lag is gone. Should drop throttle_rate to 75% ###
set @@global.debug= '-d,dbug.simulate_lag_between_start_end_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	75
####### Next Cycle #######
### Expectation - Replication lag is gone. Should drop throttle_rate to 50% ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	50
####### Next Cycle #######
### Expectation - Replication lag is gone. Should drop throttle_rate to 25% ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
CLIENT	99914b932bd37a50b983c5e7c90ae93b	25
####### Next Cycle #######
### Expectation - Replication lag is gone. Should remove the throttling rule ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test1.t values(2);
select type, value, throttle_rate from information_schema.write_throttling_rules where mode = 'AUTO';
type	value	throttle_rate
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_THROTTLE_RATE_STEP=100;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test 11: Turning off auto_throttling clears auto throttling rules only
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
# Add some manual throttling rules for sql_id
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='+SQL_ID=1234';
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='+SQL_ID=5678';
insert into test.t values(2);
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
####### Next Cycle #######
### Expectation - There is replication lag. The system should identity insert query sql_id as the culprit and throttle it ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
insert into test.t values(2);
select type, value, mode from information_schema.write_throttling_rules order by value desc;
type	value	mode
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	AUTO
SQL_ID	5678	MANUAL
SQL_ID	1234	MANUAL
# Setting WRITE_AUTO_THROTTLE_FREQUENCY=0 should clear auto throttling rules
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=0;
select type, value, mode from information_schema.write_throttling_rules order by value desc;
type	value	mode
SQL_ID	5678	MANUAL
SQL_ID	1234	MANUAL
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=@wat_freq;
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################################################################
### Test 12: Auto throttle dimensions are configurable, No throttling if no permissible dimension is set
####################################################################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="OFF";
insert into test.t values(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	144
SHARD	test	72
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	36
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a55a8f3e636afbb0ca6168a0e024ee84	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. But since no permissible throttling dimension is set, no query should be throttled. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="SQL_ID,SHARD,CLIENT,USER";
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################################################################
### Test 13: Auto throttle dimensions are configurable, only permissible dimensions are throttled
####################################################################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="SHARD,SQL_ID";
insert into test.t values(2),(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	154
SHARD	test	82
SHARD	test1	72
SQL_ID	494bb2dc69dd407b05c40cde52aabbaf	36
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	41
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	36
SQL_ID	a0cd46b1234fe77586e9610601dd7786	41
USER	root	154
####### Next Cycle #######
### Expectation - There is replication lag. Since there is no clear culprit among SHARD & SQL_ID dimensions, system should quarantine first SHARD. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SHARD	test
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="SQL_ID,SHARD,CLIENT,USER";
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################################################################
### Test 14: Auto throttle dimensions are configurable, only permissible dimensions are throttled
### Also, configuration is applied properly when set via command line params
####################################################################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="OFF";
include/sync_slave_sql_with_master.inc
include/stop_slave_io.inc
include/rpl_restart_server.inc [server_number=1 parameters: --sql_stats_control=ON --write_stats_count=10 --write_auto_throttle_frequency=1 --write_stats_frequency=1 --write_throttle_lag_pct_min_secondaries=10 --write_start_throttle_lag_milliseconds=3000 --write_stop_throttle_lag_milliseconds=1000 --write_throttle_min_ratio=1.5 --write_throttle_monitor_cycles=0 --write_control_level=WARN --write_throttle_permissible_dimensions_in_order=SQL_ID,SHARD]
[connection slave]
include/start_slave_io.inc
[connection master]
include/sync_slave_io_with_master.inc
set @@global.debug= '+d,dbug.skip_last_complete_bucket_check';
SET @@GLOBAL.bypass_write_throttle_admin_check=1;
select @@GLOBAL.WRITE_STATS_FREQUENCY into @ws_freq;
select @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY into @wat_freq;
SELECT @@global.write_throttle_permissible_dimensions_in_order;
@@global.write_throttle_permissible_dimensions_in_order
SQL_ID,SHARD
insert into test.t values(2),(2);
set @@global.debug= '+d,dbug.add_write_stats_to_most_recent_bucket';
delete from test.t where a = 2;
use test1;
insert into test1.t values(2),(2);
delete from test1.t where a = 2;
set @@global.debug= '-d,dbug.add_write_stats_to_most_recent_bucket';
select type, value, write_data_bytes from information_schema.write_statistics where timestamp = (select max(timestamp) from information_schema.write_statistics);
type	value	write_data_bytes
CLIENT	99914b932bd37a50b983c5e7c90ae93b	164
SHARD	test	82
SHARD	test1	82
SQL_ID	1cfc066435e061b86062384419c2dc08	41
SQL_ID	5a2a9251c1b582bd13192a8685dd6006	41
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88	41
SQL_ID	a0cd46b1234fe77586e9610601dd7786	41
USER	root	164
####### Next Cycle #######
### Expectation - There is replication lag. Since there is no clear culprit among SHARD & SQL_ID dimensions, system should quarantine first SQL_ID. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
select type, value from information_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	725b9fef2a54aea58bb80fe31af1cb88
####### Reset #######
use test;
TRUNCATE test.t;
TRUNCATE test1.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="SQL_ID,SHARD,CLIENT,USER";
flush statistics;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
####################################################
### Test End: Full Reset
####################################################
SET @@GLOBAL.WRITE_STATS_FREQUENCY=0;
DROP TABLE t;
DROP DATABASE test1;
SET @@GLOBAL.SQL_STATS_CONTROL="OFF_HARD";
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=0;
SET @@GLOBAL.WRITE_STATS_FREQUENCY=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_LAG_PCT_MIN_SECONDARIES=100;
SET @@GLOBAL.WRITE_START_THROTTLE_LAG_MILLISECONDS=86400000;
SET @@GLOBAL.WRITE_STOP_THROTTLE_LAG_MILLISECONDS=86400000;
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=1000;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1000;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=OFF;
SET @@GLOBAL.WRITE_THROTTLE_PERMISSIBLE_DIMENSIONS_IN_ORDER="OFF";
set @@global.debug= '-d,dbug.skip_last_complete_bucket_check';
SET @@GLOBAL.bypass_write_throttle_admin_check=0;
set @@GLOBAL.sql_mode=default;
include/rpl_end.inc
